<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Gastos Casa"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>Gastos Casa</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Nunito', 'Segoe UI', sans-serif; background: #F7F8FA; min-height: 100vh; max-width: 430px; margin: 0 auto; padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
    input, button { font-family: inherit; }
    button { cursor: pointer; }
    #login-screen { min-height: 100vh; background: #F0F4FA; display: flex; flex-direction: column; justify-content: center; padding: 32px 28px; }
    .login-hero { margin-bottom: 36px; }
    .login-hero .emoji { font-size: 44px; margin-bottom: 12px; }
    .login-hero h1 { font-size: 28px; font-weight: 900; color: #0F172A; line-height: 1.2; }
    .login-hero p { font-size: 14px; color: #64748B; margin-top: 8px; }
    .login-card { background: #fff; border-radius: 20px; padding: 28px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); }
    .field-label { font-size: 11px; font-weight: 700; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.8px; display: block; margin-bottom: 8px; }
    .field-group { margin-bottom: 18px; }
    .text-input { width: 100%; padding: 13px 16px; border-radius: 12px; border: 1.5px solid #E2E8F0; font-size: 15px; font-weight: 600; color: #0F172A; outline: none; }
    .text-input:focus { border-color: #2563EB; }
    .code-input { letter-spacing: 3px; color: #2563EB; font-weight: 700; text-transform: uppercase; }
    .hint { font-size: 11px; color: #94A3B8; margin-top: 6px; line-height: 1.5; }
    .error-box { background: #FEF2F2; border: 1px solid #FCA5A5; border-radius: 10px; padding: 10px 14px; font-size: 13px; color: #EF4444; margin-bottom: 16px; }
    .btn-primary { width: 100%; padding: 15px; border-radius: 14px; border: none; background: #2563EB; color: #fff; font-weight: 800; font-size: 16px; }
    .btn-primary:disabled { background: #CBD5E1; cursor: not-allowed; }
    #app-header { background: #fff; padding: 18px 20px 14px; border-bottom: 1px solid #EAEDF2; position: sticky; top: 0; z-index: 100; }
    .header-home { display: flex; justify-content: space-between; align-items: flex-end; }
    .header-label { font-size: 11px; color: #9BA3AF; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
    .header-title { font-size: 20px; font-weight: 900; color: #1A1D23; margin-top: 2px; }
    .avatar-stack { display: flex; align-items: center; }
    .avatar { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; border: 2px solid #fff; margin-left: -8px; position: relative; }
    .avatar:first-child { margin-left: 0; }
    .avatar.me { background: #2563EB; color: #fff; }
    .avatar.other { background: #E2E8F0; color: #64748B; }
    .header-back { display: flex; align-items: center; gap: 12px; }
    .back-btn { background: none; border: none; font-size: 20px; color: #6B7280; padding: 0; }
    .header-back-title { font-size: 18px; font-weight: 700; color: #1A1D23; }
    .month-pills { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 18px; scrollbar-width: none; }
    .month-pills::-webkit-scrollbar { display: none; }
    .pill { flex-shrink: 0; padding: 5px 14px; border-radius: 20px; border: none; font-weight: 600; font-size: 13px; }
    .pill.active { background: #2563EB; color: #fff; }
    .pill.inactive { background: #EEF0F5; color: #6B7280; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .summary-card { background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .card-label { font-size: 10px; color: #9BA3AF; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
    .card-amount-blue { font-size: 20px; font-weight: 800; color: #2563EB; margin-top: 5px; }
    .card-amount-green { font-size: 20px; font-weight: 800; color: #059669; margin-top: 5px; }
    .total-card { background: #1A1D23; border-radius: 16px; padding: 18px 20px; margin-bottom: 22px; box-shadow: 0 2px 12px rgba(26,29,35,0.15); }
    .total-label { font-size: 11px; color: #6B7280; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .total-amount { font-size: 28px; font-weight: 900; color: #fff; margin-top: 4px; }
    .total-count { font-size: 12px; color: #4B5563; margin-top: 4px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .section-title { font-weight: 700; font-size: 15px; color: #1A1D23; }
    .link-btn { background: none; border: none; color: #2563EB; font-weight: 600; font-size: 13px; }
    .empty-state { text-align: center; padding: 50px 0; color: #9BA3AF; font-size: 14px; }
    .empty-emoji { font-size: 36px; margin-bottom: 10px; }
    .gasto-list { display: flex; flex-direction: column; gap: 8px; }
    .gasto-item { background: #fff; border-radius: 14px; padding: 13px 15px; display: flex; align-items: center; gap: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .gasto-icon { width: 40px; height: 40px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 19px; flex-shrink: 0; }
    .gasto-icon.personal { background: #EFF6FF; }
    .gasto-icon.casa { background: #ECFDF5; }
    .gasto-info { flex: 1; min-width: 0; }
    .gasto-name { font-weight: 700; font-size: 13px; color: #1A1D23; }
    .gasto-meta { font-size: 11px; color: #9BA3AF; margin-top: 2px; }
    .gasto-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .gasto-amount { font-weight: 800; font-size: 14px; color: #1A1D23; }
    .gasto-autor { font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px; }
    .gasto-autor.me { background: #EFF6FF; color: #2563EB; }
    .gasto-autor.other { background: #F0FDF4; color: #059669; }
    .del-btn { background: none; border: none; font-size: 13px; color: #EF4444; padding: 0; }
    .tab-bar { display: flex; background: #EEF0F5; border-radius: 12px; padding: 4px; margin-bottom: 22px; }
    .tab-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 700; font-size: 14px; transition: all 0.15s; }
    .tab-btn.active { background: #fff; color: #1A1D23; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .tab-btn.inactive { background: transparent; color: #9BA3AF; }
    .cat-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 20px; }
    .cat-btn { padding: 11px 6px; border-radius: 12px; border: 2px solid; background: #fff; text-align: center; transition: all 0.1s; }
    .cat-btn.selected { border-color: #2563EB; background: #EFF6FF; }
    .cat-btn.unselected { border-color: #EAEDF2; }
    .cat-icon { font-size: 22px; }
    .cat-label { font-size: 10px; font-weight: 700; margin-top: 4px; }
    .cat-label.selected { color: #2563EB; }
    .cat-label.unselected { color: #6B7280; }
    .form-group { margin-bottom: 14px; }
    .amount-wrap { position: relative; }
    .amount-input { width: 100%; padding: 14px 48px 14px 16px; border-radius: 12px; border: 1.5px solid #EAEDF2; font-size: 18px; font-weight: 700; color: #1A1D23; outline: none; }
    .amount-input:focus { border-color: #2563EB; }
    .euro-sign { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #9BA3AF; font-weight: 700; }
    .date-input, .note-input { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1.5px solid #EAEDF2; font-size: 15px; color: #1A1D23; outline: none; }
    .date-input:focus, .note-input:focus { border-color: #2563EB; }
    .save-btn { width: 100%; padding: 15px; border-radius: 14px; border: none; color: #fff; font-weight: 800; font-size: 16px; margin-top: 12px; }
    .save-btn.ready { background: #2563EB; }
    .save-btn.disabled { background: #C7D2E7; cursor: not-allowed; }
    .stat-card { background: #fff; border-radius: 16px; padding: 18px; margin-bottom: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .stat-card-title { font-size: 11px; font-weight: 700; color: #9BA3AF; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px; }
    .dist-bar { display: flex; border-radius: 8px; overflow: hidden; height: 14px; margin-bottom: 14px; }
    .dist-personal { background: #2563EB; }
    .dist-casa { background: #059669; flex: 1; }
    .dist-legend { display: flex; gap: 20px; }
    .legend-item { display: flex; align-items: center; gap: 7px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 3px; }
    .legend-label { font-size: 13px; color: #6B7280; }
    .legend-val { font-weight: 700; font-size: 13px; color: #1A1D23; }
    .bar-row { margin-bottom: 14px; }
    .bar-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .bar-row-name { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 13px; color: #1A1D23; }
    .bar-row-val { font-weight: 700; font-size: 13px; color: #1A1D23; }
    .progress-bg { background: #EEF0F5; border-radius: 6px; height: 6px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 6px; transition: width 0.4s; }
    #bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: #fff; border-top: 1px solid #EAEDF2; display: flex; align-items: center; justify-content: space-around; padding: 10px 0 16px; z-index: 200; }
    .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .nav-btn .nav-icon { font-size: 22px; }
    .nav-btn .nav-label { font-size: 10px; font-weight: 700; }
    .nav-label.active { color: #2563EB; }
    .nav-label.inactive { color: #9BA3AF; }
    .add-fab { background: #2563EB; border: none; width: 54px; height: 54px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #fff; box-shadow: 0 4px 16px rgba(37,99,235,0.35); margin-top: -20px; }
    #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1A1D23; color: #fff; padding: 10px 20px; border-radius: 24px; font-size: 14px; font-weight: 600; z-index: 999; white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,0.2); display: none; }
    .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: #10B981; display: inline-block; margin-left: 6px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .stats-btn { width: 100%; margin-top: 14px; padding: 13px; border-radius: 14px; border: 1.5px solid #EAEDF2; background: #fff; color: #2563EB; font-weight: 700; font-size: 14px; }
    .screen { display: none; padding: 18px; }
    .screen.active { display: block; }
  </style>
</head>
<body>
<div id="login-screen">
  <div class="login-hero">
    <div class="emoji">üí∞</div>
    <h1>Control de<br/>Gastos</h1>
    <p>Comparte los gastos con tu pareja o familia usando un c√≥digo de sala.</p>
  </div>
  <div class="login-card">
    <div class="field-group">
      <label class="field-label">Tu nombre</label>
      <input class="text-input" id="input-name" placeholder="Ej: Jose" type="text" autocomplete="off"/>
    </div>
    <div class="field-group">
      <label class="field-label">C√≥digo de sala</label>
      <input class="text-input code-input" id="input-room" placeholder="Ej: CASA2025" type="text" autocomplete="off" maxlength="20"/>
      <p class="hint">Si el c√≥digo no existe se crea autom√°ticamente. Comp√°rtelo con la otra persona.</p>
    </div>
    <div id="login-error" class="error-box" style="display:none"></div>
    <button class="btn-primary" id="btn-join" onclick="doJoin()">Entrar ‚Üí</button>
  </div>
</div>
<div id="app" style="display:none">
  <div id="app-header">
    <div id="hdr-home" class="header-home">
      <div>
        <div class="header-label">Sala ¬∑ <span id="hdr-room-code"></span><span class="sync-dot"></span></div>
        <div class="header-title" id="hdr-month-title"></div>
      </div>
      <div class="avatar-stack" id="avatar-stack"></div>
    </div>
    <div id="hdr-back" class="header-back" style="display:none">
      <button class="back-btn" onclick="goHome()">‚Üê</button>
      <span class="header-back-title" id="hdr-back-title"></span>
    </div>
  </div>
  <div id="home-screen" class="screen active" style="padding:18px">
    <div class="month-pills" id="month-pills"></div>
    <div class="summary-grid">
      <div class="summary-card"><div class="card-label">Personal</div><div class="card-amount-blue" id="total-personal">0,00 ‚Ç¨</div></div>
      <div class="summary-card"><div class="card-label">Casa</div><div class="card-amount-green" id="total-casa">0,00 ‚Ç¨</div></div>
    </div>
    <div class="total-card">
      <div class="total-label">Total del mes</div>
      <div class="total-amount" id="total-mes">0,00 ‚Ç¨</div>
      <div class="total-count" id="total-count">0 movimientos</div>
    </div>
    <div class="section-header">
      <span class="section-title">Recientes</span>
      <button class="link-btn" onclick="showScreen('history')">Ver todo</button>
    </div>
    <div id="recent-list"></div>
    <button class="stats-btn" id="stats-btn" onclick="showScreen('stats')" style="display:none">üìä Ver estad√≠sticas del mes</button>
  </div>
  <div id="add-screen" class="screen">
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-personal" onclick="switchTab('personal')">üë§ Personal</button>
      <button class="tab-btn inactive" id="tab-casa" onclick="switchTab('casa')">üè† Casa</button>
    </div>
    <div class="field-label" style="margin-bottom:10px">Categor√≠a</div>
    <div class="cat-grid" id="cat-grid"></div>
    <div class="form-group">
      <label class="field-label">Importe</label>
      <div class="amount-wrap">
        <input class="amount-input" id="input-importe" type="number" inputmode="decimal" placeholder="0.00"/>
        <span class="euro-sign">‚Ç¨</span>
      </div>
    </div>
    <div class="form-group">
      <label class="field-label">Fecha</label>
      <input class="date-input" id="input-fecha" type="date"/>
    </div>
    <div class="form-group">
      <label class="field-label">Nota (opcional)</label>
      <input class="note-input" id="input-nota" type="text" placeholder="Descripci√≥n..."/>
    </div>
    <button class="save-btn disabled" id="btn-save" onclick="saveGasto()">Guardar gasto</button>
  </div>
  <div id="history-screen" class="screen">
    <div class="month-pills" id="history-pills"></div>
    <div id="history-list"></div>
  </div>
  <div id="stats-screen" class="screen">
    <div class="month-pills" id="stats-pills"></div>
    <div class="stat-card">
      <div class="stat-card-title">Distribuci√≥n</div>
      <div id="dist-content"></div>
    </div>
    <div class="stat-card" id="person-card" style="display:none">
      <div class="stat-card-title">Por persona</div>
      <div id="person-content"></div>
    </div>
    <div class="stat-card">
      <div class="stat-card-title">Por categor√≠a</div>
      <div id="cats-content"></div>
    </div>
  </div>
  <div id="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span class="nav-label active" id="nav-home-lbl">Inicio</span></button>
    <button class="add-fab" onclick="showScreen('add')">+</button>
    <button class="nav-btn" onclick="showScreen('history')"><span class="nav-icon">üìã</span><span class="nav-label inactive" id="nav-hist-lbl">Historial</span></button>
  </div>
</div>
<div id="toast"></div>
<script>
const firebaseConfig={apiKey:"AIzaSyDfyjJg5RrJ39s8VZEn6WZi6bv-4xDl-vM",authDomain:"gastos-casa-eb2f0.firebaseapp.com",databaseURL:"https://gastos-casa-eb2f0-default-rtdb.europe-west1.firebasedatabase.app",projectId:"gastos-casa-eb2f0",storageBucket:"gastos-casa-eb2f0.firebasestorage.app",messagingSenderId:"1049519278128",appId:"1:1049519278128:web:9f686b2371620a350545f5"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const CATS={personal:[{id:"ropa",label:"Ropa",icon:"üëï"},{id:"ocio",label:"Ocio",icon:"üé¨"},{id:"salud",label:"Salud",icon:"üíä"},{id:"transporte",label:"Transporte",icon:"üöó"},{id:"restaurantes",label:"Restaurantes",icon:"üçΩÔ∏è"},{id:"otro_p",label:"Otros",icon:"üì¶"}],casa:[{id:"hipoteca",label:"Hipoteca",icon:"üè†"},{id:"luz",label:"Luz/Gas",icon:"‚ö°"},{id:"agua",label:"Agua",icon:"üíß"},{id:"internet",label:"Internet",icon:"üì°"},{id:"compra",label:"Compra",icon:"üõí"},{id:"escolar",label:"Escolar",icon:"üéí"},{id:"mantenimiento",label:"Mantenimiento",icon:"üîß"}]};
const ALL_CATS=[...CATS.personal,...CATS.casa];
const getCat=id=>ALL_CATS.find(c=>c.id===id);
const MONTHS=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
let userName="",roomCode="",gastos=[],members=[],currentMonth=getMonthKey(new Date()),activeTab="personal",selectedCat="",currentView="home";
function getMonthKey(d){return`${d.getFullYear()}-${d.getMonth()}`}
function parseMonthKey(k){const[y,m]=k.split("-").map(Number);return{year:y,month:m}}
function fmt(n){return n.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨"}
function today(){return new Date().toISOString().split("T")[0]}
const saved=JSON.parse(localStorage.getItem("session")||"null");
if(saved){userName=saved.name;roomCode=saved.room;startApp()}
async function doJoin(){
  const name=document.getElementById("input-name").value.trim();
  const room=document.getElementById("input-room").value.trim().toUpperCase();
  const errEl=document.getElementById("login-error");
  if(!name){showErr("Escribe tu nombre.");return}
  if(room.length<3){showErr("El c√≥digo debe tener al menos 3 caracteres.");return}
  document.getElementById("btn-join").disabled=true;
  document.getElementById("btn-join").textContent="Entrando...";
  try{
    const ref=db.ref(`rooms/${room}/members`);
    const snap=await ref.once("value");
    let mems=snap.val()||[];
    if(!mems.includes(name)){mems.push(name);await ref.set(mems)}
    userName=name;roomCode=room;
    localStorage.setItem("session",JSON.stringify({name,room}));
    startApp()
  }catch(e){showErr("Error conectando con Firebase. Revisa la conexi√≥n.");document.getElementById("btn-join").disabled=false;document.getElementById("btn-join").textContent="Entrar ‚Üí"}
  function showErr(msg){errEl.textContent=msg;errEl.style.display="block";document.getElementById("btn-join").disabled=false;document.getElementById("btn-join").textContent="Entrar ‚Üí"}
}
function startApp(){
  document.getElementById("login-screen").style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("hdr-room-code").textContent=roomCode;
  document.getElementById("input-fecha").value=today();
  db.ref(`rooms/${roomCode}`).on("value",snap=>{
    const data=snap.val()||{};
    gastos=data.gastos?Object.values(data.gastos).sort((a,b)=>b.ts-a.ts):[];
    members=data.members||[];
    renderAll()
  });
  renderCatGrid();
  const now=new Date();
  document.getElementById("hdr-month-title").textContent=`${MONTHS[now.getMonth()]} ${now.getFullYear()}`
}
function getMonths(){const now=getMonthKey(new Date());const set=new Set(gastos.map(g=>getMonthKey(new Date(g.fecha))));set.add(now);return[...set].sort().reverse()}
function renderAll(){renderAvatars();renderMonthPills();renderHome();if(currentView==="history")renderHistory();if(currentView==="stats")renderStats()}
function renderAvatars(){document.getElementById("avatar-stack").innerHTML=members.map(m=>`<div class="avatar ${m===userName?'me':'other'}">${m[0].toUpperCase()}</div>`).join("")}
function renderMonthPills(){const months=getMonths();["month-pills","history-pills","stats-pills"].forEach(id=>{const el=document.getElementById(id);if(!el)return;const now=new Date();el.innerHTML=months.map(mk=>{const{year,month}=parseMonthKey(mk);return`<button class="pill ${mk===currentMonth?'active':'inactive'}" onclick="setMonth('${mk}')">${MONTHS[month]}${year!==now.getFullYear()?' '+year:''}</button>`}).join("")})}
function renderHome(){const mg=gastos.filter(g=>getMonthKey(new Date(g.fecha))===currentMonth);const tP=mg.filter(g=>CATS.personal.find(c=>c.id===g.categoria)).reduce((s,g)=>s+g.importe,0);const tC=mg.filter(g=>CATS.casa.find(c=>c.id===g.categoria)).reduce((s,g)=>s+g.importe,0);const tM=tP+tC;document.getElementById("total-personal").textContent=fmt(tP);document.getElementById("total-casa").textContent=fmt(tC);document.getElementById("total-mes").textContent=fmt(tM);document.getElementById("total-count").textContent=`${mg.length} movimiento${mg.length!==1?'s':''}`;document.getElementById("stats-btn").style.display=mg.length>0?"block":"none";const rl=document.getElementById("recent-list");if(mg.length===0){rl.innerHTML=`<div class="empty-state"><div class="empty-emoji">üí∏</div>Sin gastos este mes</div>`}else{rl.innerHTML=`<div class="gasto-list">${mg.slice(0,6).map(g=>gastoHTML(g,false)).join("")}</div>`}}
function renderHistory(){const mg=gastos.filter(g=>getMonthKey(new Date(g.fecha))===currentMonth);const hl=document.getElementById("history-list");if(mg.length===0){hl.innerHTML=`<div class="empty-state">Sin movimientos</div>`}else{hl.innerHTML=`<div class="gasto-list">${mg.map(g=>gastoHTML(g,true)).join("")}</div>`}}
function gastoHTML(g,showDel){const cat=getCat(g.categoria);const isMe=g.autor===userName;const delBtn=(showDel&&isMe)?`<button class="del-btn" onclick="delGasto('${g.id}')">‚úï</button>`:"";return`<div class="gasto-item"><div class="gasto-icon ${g.tipo||'personal'}">${cat?cat.icon:'üì¶'}</div><div class="gasto-info"><div class="gasto-name">${cat?cat.label:g.categoria}</div><div class="gasto-meta">${new Date(g.fecha).toLocaleDateString("es-ES")}${g.nota?' ¬∑ '+g.nota:''}</div></div><div class="gasto-right"><div class="gasto-amount">${fmt(g.importe)}</div><div class="gasto-autor ${isMe?'me':'other'}">${g.autor||'?'}</div>${delBtn}</div></div>`}
function renderStats(){const mg=gastos.filter(g=>getMonthKey(new Date(g.fecha))===currentMonth);const tP=mg.filter(g=>CATS.personal.find(c=>c.id===g.categoria)).reduce((s,g)=>s+g.importe,0);const tC=mg.filter(g=>CATS.casa.find(c=>c.id===g.categoria)).reduce((s,g)=>s+g.importe,0);const tM=tP+tC;const dc=document.getElementById("dist-content");if(tM===0){dc.innerHTML=`<p style="color:#9BA3AF;font-size:14px">Sin datos</p>`}else{const pPct=(tP/tM)*100;dc.innerHTML=`<div class="dist-bar"><div class="dist-personal" style="width:${pPct}%"></div><div class="dist-casa"></div></div><div class="dist-legend"><div class="legend-item"><div class="legend-dot" style="background:#2563EB"></div><span class="legend-label">Personal</span><span class="legend-val">${fmt(tP)}</span></div><div class="legend-item"><div class="legend-dot" style="background:#059669"></div><span class="legend-label">Casa</span><span class="legend-val">${fmt(tC)}</span></div></div>`}const pc=document.getElementById("person-card");if(members.length>1){pc.style.display="block";document.getElementById("person-content").innerHTML=members.map(m=>{const total=mg.filter(g=>g.autor===m).reduce((s,g)=>s+g.importe,0);const pct=tM>0?(total/tM)*100:0;return`<div class="bar-row"><div class="bar-row-header"><span class="bar-row-name">${m}</span><span class="bar-row-val">${fmt(total)}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${pct}%;background:#2563EB"></div></div></div>`}).join("")}else{pc.style.display="none"}const bycat={};mg.forEach(g=>{bycat[g.categoria]=(bycat[g.categoria]||0)+g.importe});const sorted=Object.entries(bycat).sort((a,b)=>b[1]-a[1]);const cc=document.getElementById("cats-content");if(sorted.length===0){cc.innerHTML=`<p style="color:#9BA3AF;font-size:14px">Sin datos</p>`}else{cc.innerHTML=sorted.map(([catId,total])=>{const cat=getCat(catId);const pct=tM>0?(total/tM)*100:0;const isP=!!CATS.personal.find(c=>c.id===catId);return`<div class="bar-row"><div class="bar-row-header"><span class="bar-row-name">${cat?cat.icon:'üì¶'} ${cat?cat.label:catId}</span><span class="bar-row-val">${fmt(total)}</span></div><div class="progress-bg"><div class="progress-fill" style="width:${pct}%;background:${isP?'#2563EB':'#059669'}"></div></div></div>`}).join("")}}
function renderCatGrid(){selectedCat="";document.getElementById("cat-grid").innerHTML=CATS[activeTab].map(cat=>`<button class="cat-btn unselected" id="cat-${cat.id}" onclick="selectCat('${cat.id}')"><div class="cat-icon">${cat.icon}</div><div class="cat-label unselected">${cat.label}</div></button>`).join("");checkSaveBtn()}
function switchTab(tab){activeTab=tab;document.getElementById("tab-personal").className=`tab-btn ${tab==='personal'?'active':'inactive'}`;document.getElementById("tab-casa").className=`tab-btn ${tab==='casa'?'active':'inactive'}`;renderCatGrid()}
function selectCat(id){selectedCat=id;document.querySelectorAll(".cat-btn").forEach(b=>{b.className="cat-btn unselected";b.querySelector(".cat-label").className="cat-label unselected"});const btn=document.getElementById(`cat-${id}`);if(btn){btn.className="cat-btn selected";btn.querySelector(".cat-label").className="cat-label selected"}checkSaveBtn()}
function checkSaveBtn(){const imp=document.getElementById("input-importe").value;const ready=selectedCat&&imp&&!isNaN(parseFloat(imp));const btn=document.getElementById("btn-save");btn.className=`save-btn ${ready?'ready':'disabled'}`;btn.disabled=!ready}
document.getElementById("input-importe").addEventListener("input",checkSaveBtn);
async function saveGasto(){const importe=parseFloat(document.getElementById("input-importe").value);if(!selectedCat||isNaN(importe))return;const tipo=CATS.personal.find(c=>c.id===selectedCat)?"personal":"casa";const gasto={id:Date.now()+"_"+Math.random().toString(36).slice(2),tipo,categoria:selectedCat,importe,nota:document.getElementById("input-nota").value.trim(),fecha:document.getElementById("input-fecha").value,autor:userName,ts:Date.now()};try{await db.ref(`rooms/${roomCode}/gastos/${gasto.id}`).set(gasto);document.getElementById("input-importe").value="";document.getElementById("input-nota").value="";document.getElementById("input-fecha").value=today();selectedCat="";renderCatGrid();showToast("Gasto a√±adido ‚úì");showScreen("home")}catch(e){showToast("Error al guardar")}}
async function delGasto(id){try{await db.ref(`rooms/${roomCode}/gastos/${id}`).remove();showToast("Eliminado")}catch(e){showToast("Error al eliminar")}}
function showScreen(name){currentView=name;["home","add","history","stats"].forEach(s=>{document.getElementById(`${s}-screen`).className=`screen${s===name?' active':''}`});const isHome=name==="home";document.getElementById("hdr-home").style.display=isHome?"flex":"none";document.getElementById("hdr-back").style.display=isHome?"none":"flex";const titles={add:"Nuevo gasto",history:"Historial",stats:"Estad√≠sticas"};if(!isHome)document.getElementById("hdr-back-title").textContent=titles[name]||"";document.getElementById("nav-home-lbl").className=`nav-label ${name==='home'?'active':'inactive'}`;document.getElementById("nav-hist-lbl").className=`nav-label ${name==='history'?'active':'inactive'}`;if(name==="history")renderHistory();if(name==="stats")renderStats();renderMonthPills();window.scrollTo(0,0)}
function goHome(){showScreen("home")}
function setMonth(mk){currentMonth=mk;renderMonthPills();renderHome();if(currentView==="history")renderHistory();if(currentView==="stats")renderStats()}
function showToast(msg){const t=document.getElementById("toast");t.textContent=msg;t.style.display="block";setTimeout(()=>{t.style.display="none"},2200)}
</script>
</body>
</html>
